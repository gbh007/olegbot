<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Oleg CMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      table.data {
        width: 100%;
      }
      button.red {
        color: #ff0000;
        font-size: large;
      }
      pre.quote {
        background-color: #d3d3d3;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <button onclick="refresh()">Обновить</button>
    <button onclick="quoteAdd()">Добавить</button>
    <br />
    <table class="data">
      <thead>
        <tr>
          <th>ID</th>
          <th>Добавлен</th>
          <th>Описание</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="moderators"></tbody>
    </table>
    <script>
      async function refresh() {
        let moderatorsNode = document.getElementById("moderators");

        try {
          let response = await fetch("/api/moderators", { method: "GET" });

          if (!response.ok) {
            throw new Error(await response.text());
          }

          let data = await response.json();

          moderatorsNode.innerHTML = (data || [])
            .map(
              (e) => `<tr>
                        <td>${e.user_id}</td>
                        <td>${new Date(e.create_at).toLocaleString()}</td>
                        <td>${e.description || ""}</td>
                        <td>
                            <button class="red" onclick="moderatorDelete(${
                              e.user_id
                            })">Удалить</button>
                        </td>
                      </tr>`
            )
            .join("\n");
        } catch (err) {
          alert(err);
        }
      }

      async function quoteAdd() {
        let userID = parseInt(prompt("Введите ID пользователя"));
        if (!userID) {
          return;
        }

        let text = prompt("Введите описание");

        try {
          let response = await fetch(`/api/moderator`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json; charset=UTF-8",
            },
            body: JSON.stringify({
              user_id: userID,
              description: text,
            }),
          });

          if (!response.ok) {
            throw new Error(await response.text());
          }

          refresh();
        } catch (err) {
          alert(err);
        }
      }

      async function moderatorDelete(id) {
        if (!confirm(`Удалить модератора #${id}`)) {
          return;
        }

        try {
          let response = await fetch(`/api/moderator?id=${id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error(await response.text());
          }

          refresh();
        } catch (err) {
          alert(err);
        }
      }

      window.addEventListener("load", refresh);
    </script>
  </body>
</html>
